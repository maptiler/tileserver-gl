name: Create bump version PR
on:
  workflow_dispatch:
    inputs:
      version:
        description: Version bump type.
        required: true
        type: choice
        options:
          - prerelease
          - prepatch
          - preminor
          - premajor
          - patch
          - minor
          - major
      preid:
        description: Prerelease identifier (e.g., 'alpha', 'beta', 'rc'). Only used with prerelease version types.
        required: false
        type: string
        default: 'pre'
jobs:
  bump-version-pr:
    name: Bump version PR
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: master
      - name: Setup node env ðŸ“¦
        uses: actions/setup-node@v6
        with:
          node-version-file: 'package.json'
          check-latest: true
          cache: 'npm'
      - name: Create bump script
        run: |
          cat > bump-version.mjs << 'EOF'
          import { execSync } from 'child_process';
          import * as fs from 'fs';

          const versionType = process.argv[2];
          const preid = process.argv[3];
          const changelogPath = 'CHANGELOG.md';

          let newVersion = '';

          // Build npm version command
          let versionCmd = `npm version --commit-hooks false --git-tag-version false ${versionType}`;
          if (preid && preid.trim() !== '') {
            versionCmd += ` --preid=${preid}`;
            console.log(`Using preid: ${preid}`);
          }

          console.log('Bumping version in root package.json');
          execSync(versionCmd, {
            stdio: 'inherit'
          });

          // Get the new version
          const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          newVersion = packageJson.version;

          console.log(`New version: ${newVersion}`);

          // Update changelog
          console.log(`Checking for changelog at: ${changelogPath}`);
          if (!fs.existsSync(changelogPath)) {
            console.log(`No changelog found at ${changelogPath}, skipping changelog update`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `version=${newVersion}\n`);
            process.exit(0);
          }

          let changelog = fs.readFileSync(changelogPath, 'utf8');

          // Get PRs since last tag
          console.log('Fetching PRs since last tagged version...');
          let latestTag;
          try {
            latestTag = execSync('git describe --tags --abbrev=0', { encoding: 'utf8' }).trim();
            console.log(`Latest tag: ${latestTag}`);
          } catch (error) {
            console.log('No previous tags found, using all commits');
            latestTag = '';
          }

          // Get commit range
          const commitRange = latestTag ? `${latestTag}..HEAD` : 'HEAD';
          
          // Get all PR numbers from commit messages
          let commits;
          try {
            commits = execSync(`git log ${commitRange} --oneline`, { encoding: 'utf8' });
          } catch (error) {
            console.log('No commits found');
            commits = '';
          }

          // Extract PR numbers from merge commits
          const prNumbers = [];
          const prRegex = /#(\d+)/g;
          let match;
          while ((match = prRegex.exec(commits)) !== null) {
            prNumbers.push(match[1]);
          }

          console.log(`Found ${prNumbers.length} PRs since last tag`);

          // Check which PR numbers are missing from changelog
          const missingPrNumbers = prNumbers.filter(prNum => !changelog.includes(`#${prNum}`));
          const missingEntries = [];
          
          if (missingPrNumbers.length === 0) {
            console.log('All PRs are already in the changelog');
          } else {
            console.log(`Found ${missingPrNumbers.length} missing PRs, fetching details...`);

            // Get repository info for PR links
            let repoFullName;
            try {
              const remoteUrl = execSync('git config --get remote.origin.url', { encoding: 'utf8' }).trim();
              const repoMatch = remoteUrl.match(/github\.com[:/](.+?)(?:\.git)?$/);
              repoFullName = repoMatch ? repoMatch[1] : null;
            } catch (error) {
              console.log('Could not determine repository name');
              repoFullName = null;
            }

            // Fetch PR details using gh CLI only for missing PRs
            for (const prNumber of missingPrNumbers) {
              try {
                const prJson = execSync(`gh pr view ${prNumber} --json title,author,number`, { encoding: 'utf8' });
                const pr = JSON.parse(prJson);
                
                // Skip dependabot PRs
                if (pr.author.login.includes('dependabot')) {
                  console.log(`Skipping dependabot PR #${prNumber}`);
                  continue;
                }

                const prUrl = repoFullName ? `https://github.com/${repoFullName}/pull/${pr.number}` : `#${pr.number}`;
                const entry = `- ${pr.title} ([#${pr.number}](${prUrl})) (by [${pr.author.login}](https://github.com/${pr.author.login}))`;
                missingEntries.push(entry);
                console.log(`Added: ${entry}`);
              } catch (error) {
                console.log(`Could not fetch details for PR #${prNumber}: ${error.message}`);
              }
            }
          }
          
          // Replace "## master" with the new version number
          changelog = changelog.replace('## master', `## ${newVersion}`);
          
          // Remove placeholder lines
          changelog = changelog.replaceAll('- _...Add new stuff here..._\n', '');
          
          // Build the new master section header
          const masterSection = `## master
          ### âœ¨ Features and improvements
          - _...Add new stuff here..._
          
          ### ðŸž Bug fixes
          - _...Add new stuff here..._
          
          `;
          
          // Add any missing PR entries after the master section
          let newContent = masterSection;
          if (missingEntries.length > 0) {
            console.log(`Adding ${missingEntries.length} missing PR entries to changelog`);
            newContent += missingEntries.join('\n') + '\n\n';
          }
          
          // Find where the content starts after the title header
          // Expected format: "# tileserver-gl changelog\n\n## <version>"
          const titleMatch = changelog.match(/^(# .+?\n\n)/);
          if (titleMatch) {
            // Preserve the title and insert master section after it
            const title = titleMatch[1];
            const rest = changelog.slice(title.length);
            changelog = title + newContent + rest;
          } else {
            // No title found, just prepend
            changelog = newContent + changelog;
          }
          
          fs.writeFileSync(changelogPath, changelog, 'utf8');
          console.log(`Changelog updated at ${changelogPath}`);

          // Write outputs to GITHUB_OUTPUT
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `version=${newVersion}\n`);
          EOF
      - name: Bump version and update changelog
        id: version-details
        run: |
          node bump-version.mjs "${{ inputs.version }}" "${{ inputs.preid }}"
          rm bump-version.mjs
        env:
          GH_TOKEN: ${{ github.token }}
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: Release v${{ steps.version-details.outputs.version }}
          branch: release-v${{ steps.version-details.outputs.version }}
          title: Release v${{ steps.version-details.outputs.version }}
